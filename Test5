-- =====================================================
-- IMPACT ANALYSIS SUITE - CORRECTED
-- Understand what breaks when data/schema issues occur
-- =====================================================

-- =====================================================
-- QUERY 1: COMPLETE DEPENDENCY CHAIN (TOP-DOWN VIEW)
-- Shows everything that could be affected downstream
-- =====================================================

DECLARE @TargetSchema NVARCHAR(128) = 'dbo';           -- Change this
DECLARE @TargetObject NVARCHAR(256) = 'YourTableName'; -- Change this

;WITH DependencyChain AS (
    -- Level 0: The source object
    SELECT 
        o.object_id,
        SCHEMA_NAME(o.schema_id) AS schema_name,
        o.name AS object_name,
        o.type AS object_type,
        o.type_desc AS object_type_desc,
        CAST(SCHEMA_NAME(o.schema_id) + '.' + o.name AS NVARCHAR(MAX)) AS full_path,
        0 AS dependency_level,
        CAST(NULL AS NVARCHAR(MAX)) AS dependency_type
    FROM sys.objects o
    WHERE o.name = @TargetObject
        AND SCHEMA_NAME(o.schema_id) = @TargetSchema
        AND o.is_ms_shipped = 0
    
    UNION ALL
    
    -- Recursive: Find all objects that depend on this
    SELECT 
        o.object_id,
        SCHEMA_NAME(o.schema_id),
        o.name,
        o.type,
        o.type_desc,
        dc.full_path + ' -> ' + SCHEMA_NAME(o.schema_id) + '.' + o.name,
        dc.dependency_level + 1,
        CASE o.type
            WHEN 'V' THEN 'VIEW'
            WHEN 'P' THEN 'STORED_PROCEDURE'
            WHEN 'FN' THEN 'SCALAR_FUNCTION'
            WHEN 'IF' THEN 'INLINE_FUNCTION'
            WHEN 'TF' THEN 'TABLE_FUNCTION'
            WHEN 'TR' THEN 'TRIGGER'
            ELSE o.type_desc
        END
    FROM DependencyChain dc
    INNER JOIN sys.sql_expression_dependencies sed ON dc.object_id = sed.referenced_id
    INNER JOIN sys.objects o ON sed.referencing_id = o.object_id
    WHERE dc.dependency_level < 20  -- Prevent infinite loops
        AND o.is_ms_shipped = 0
        AND dc.full_path NOT LIKE '%' + SCHEMA_NAME(o.schema_id) + '.' + o.name + '%'  -- Prevent circular refs
)

SELECT 
    dependency_level AS level,
    schema_name,
    object_name,
    object_type_desc,
    dependency_type AS object_type,
    full_path AS dependency_chain,
    
    -- Impact severity assessment
    CASE 
        WHEN dependency_level = 0 THEN 'ðŸŽ¯ SOURCE OBJECT'
        WHEN dependency_level = 1 THEN 'âš ï¸ DIRECT IMPACT - Will break immediately'
        WHEN dependency_level = 2 THEN 'âš¡ SECONDARY IMPACT - Will break if level 1 breaks'
        WHEN dependency_level >= 3 THEN 'ðŸ“Š CASCADE IMPACT - Multi-level cascade failure'
    END AS impact_severity,
    
    -- Get object definition to see how it's used
    OBJECT_DEFINITION(object_id) AS object_definition

FROM DependencyChain
ORDER BY dependency_level, schema_name, object_name;
