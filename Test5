-- =====================================================
-- BIDIRECTIONAL DEPENDENCY ANALYSIS - CORRECTED
-- Shows both what the object uses AND what uses it
-- =====================================================

DECLARE @TargetSchema NVARCHAR(128) = 'dbo';           -- Change this
DECLARE @TargetObject NVARCHAR(256) = 'YourProcName'; -- Change this

-- =====================================================
-- PART 1: DOWNSTREAM DEPENDENCIES
-- What depends ON this object (what breaks if this changes)
-- =====================================================

PRINT '=== DOWNSTREAM: What depends ON ' + @TargetSchema + '.' + @TargetObject + ' ==='

;WITH DownstreamChain AS (
    -- Level 0: The source object
    SELECT 
        o.object_id,
        SCHEMA_NAME(o.schema_id) AS schema_name,
        o.name AS object_name,
        o.type AS object_type_code,
        o.type_desc AS object_type_desc,
        CASE o.type
            WHEN 'U' THEN 'TABLE'
            WHEN 'V' THEN 'VIEW'
            WHEN 'P' THEN 'STORED_PROCEDURE'
            WHEN 'FN' THEN 'SCALAR_FUNCTION'
            WHEN 'IF' THEN 'INLINE_FUNCTION'
            WHEN 'TF' THEN 'TABLE_FUNCTION'
            WHEN 'TR' THEN 'TRIGGER'
            ELSE o.type_desc
        END AS dependency_type,
        CAST(SCHEMA_NAME(o.schema_id) + '.' + o.name AS NVARCHAR(MAX)) AS full_path,
        0 AS dependency_level
    FROM sys.objects o
    WHERE o.name = @TargetObject
        AND SCHEMA_NAME(o.schema_id) = @TargetSchema
        AND o.is_ms_shipped = 0
    
    UNION ALL
    
    -- Recursive: Find all objects that depend on this
    SELECT 
        o.object_id,
        SCHEMA_NAME(o.schema_id),
        o.name,
        o.type,
        o.type_desc,
        CASE o.type
            WHEN 'U' THEN 'TABLE'
            WHEN 'V' THEN 'VIEW'
            WHEN 'P' THEN 'STORED_PROCEDURE'
            WHEN 'FN' THEN 'SCALAR_FUNCTION'
            WHEN 'IF' THEN 'INLINE_FUNCTION'
            WHEN 'TF' THEN 'TABLE_FUNCTION'
            WHEN 'TR' THEN 'TRIGGER'
            ELSE o.type_desc
        END,
        dc.full_path + ' -> ' + SCHEMA_NAME(o.schema_id) + '.' + o.name,
        dc.dependency_level + 1
    FROM DownstreamChain dc
    INNER JOIN sys.sql_expression_dependencies sed ON dc.object_id = sed.referenced_id
    INNER JOIN sys.objects o ON sed.referencing_id = o.object_id
    WHERE dc.dependency_level < 20
        AND o.is_ms_shipped = 0
        AND dc.full_path NOT LIKE '%' + SCHEMA_NAME(o.schema_id) + '.' + o.name + '%'
)

SELECT 
    dependency_level AS level,
    schema_name,
    object_name,
    dependency_type AS object_type,
    full_path AS dependency_chain,
    CASE 
        WHEN dependency_level = 0 THEN 'üéØ SOURCE OBJECT'
        WHEN dependency_level = 1 THEN '‚ö†Ô∏è DIRECT IMPACT - Will break immediately'
        WHEN dependency_level = 2 THEN '‚ö° SECONDARY IMPACT - Will break if level 1 breaks'
        WHEN dependency_level >= 3 THEN 'üìä CASCADE IMPACT - Multi-level cascade failure'
    END AS impact_severity,
    'DOWNSTREAM' AS direction
FROM DownstreamChain
WHERE dependency_level > 0  -- Exclude the source object itself
ORDER BY dependency_level, schema_name, object_name;

-- =====================================================
-- PART 2: UPSTREAM DEPENDENCIES  
-- What this object USES (what it depends on)
-- =====================================================

PRINT '=== UPSTREAM: What ' + @TargetSchema + '.' + @TargetObject + ' depends ON ==='

;WITH UpstreamChain AS (
    -- Level 0: The source object
    SELECT 
        o.object_id,
        SCHEMA_NAME(o.schema_id) AS schema_name,
        o.name AS object_name,
        o.type AS object_type_code,
        o.type_desc AS object_type_desc,
        CASE o.type
            WHEN 'U' THEN 'TABLE'
            WHEN 'V' THEN 'VIEW'
            WHEN 'P' THEN 'STORED_PROCEDURE'
            WHEN 'FN' THEN 'SCALAR_FUNCTION'
            WHEN 'IF' THEN 'INLINE_FUNCTION'
            WHEN 'TF' THEN 'TABLE_FUNCTION'
            WHEN 'TR' THEN 'TRIGGER'
            ELSE o.type_desc
        END AS dependency_type,
        CAST(SCHEMA_NAME(o.schema_id) + '.' + o.name AS NVARCHAR(MAX)) AS full_path,
        0 AS dependency_level
    FROM sys.objects o
    WHERE o.name = @TargetObject
        AND SCHEMA_NAME(o.schema_id) = @TargetSchema
        AND o.is_ms_shipped = 0
    
    UNION ALL
    
    -- Recursive: Find all objects this depends on (only objects that exist in sys.objects)
    SELECT 
        o.object_id,
        SCHEMA_NAME(o.schema_id),
        o.name,
        o.type,
        o.type_desc,
        CASE o.type
            WHEN 'U' THEN 'TABLE'
            WHEN 'V' THEN 'VIEW'
            WHEN 'P' THEN 'STORED_PROCEDURE'
            WHEN 'FN' THEN 'SCALAR_FUNCTION'
            WHEN 'IF' THEN 'INLINE_FUNCTION'
            WHEN 'TF' THEN 'TABLE_FUNCTION'
            WHEN 'TR' THEN 'TRIGGER'
            ELSE o.type_desc
        END,
        dc.full_path + ' -> ' + SCHEMA_NAME(o.schema_id) + '.' + o.name,
        dc.dependency_level + 1
    FROM UpstreamChain dc
    INNER JOIN sys.sql_expression_dependencies sed ON dc.object_id = sed.referencing_id
    INNER JOIN sys.objects o ON sed.referenced_id = o.object_id
    WHERE dc.dependency_level < 20
        AND o.is_ms_shipped = 0
        AND dc.full_path NOT LIKE '%' + SCHEMA_NAME(o.schema_id) + '.' + o.name + '%'
)

SELECT 
    dependency_level AS level,
    schema_name,
    object_name,
    dependency_type AS object_type,
    full_path AS dependency_chain,
    CASE 
        WHEN dependency_level = 0 THEN 'üéØ SOURCE OBJECT'
        WHEN dependency_level = 1 THEN 'üìå DIRECT DEPENDENCY - Uses this directly'
        WHEN dependency_level = 2 THEN 'üìé INDIRECT DEPENDENCY - Uses via level 1'
        WHEN dependency_level >= 3 THEN 'üîó DEEP DEPENDENCY - Multi-level chain'
    END AS dependency_severity,
    'UPSTREAM' AS direction
FROM UpstreamChain
WHERE dependency_level > 0  -- Exclude the source object itself
ORDER BY dependency_level, schema_name, object_name;

-- =====================================================
-- PART 3: DETAILED UPSTREAM DEPENDENCIES WITH COLUMNS
-- Shows exactly what tables/columns are being used
-- =====================================================

PRINT '=== DETAILED: What ' + @TargetSchema + '.' + @TargetObject + ' uses (with columns) ==='

SELECT 
    COALESCE(SCHEMA_NAME(o.schema_id), sed.referenced_schema_name, 'unknown') AS referenced_schema,
    COALESCE(o.name, sed.referenced_entity_name, 'unknown') AS referenced_object,
    COALESCE(o.type_desc, sed.referenced_class_desc, 'UNKNOWN') AS object_type,
    
    -- If it's a specific column reference
    CASE 
        WHEN sed.referenced_minor_id > 0 THEN COL_NAME(sed.referenced_id, sed.referenced_minor_id)
        ELSE '(All columns or object-level)'
    END AS referenced_column,
    
    sed.is_ambiguous,
    sed.is_caller_dependent,
    
    -- Show if it's a cross-database reference
    COALESCE(sed.referenced_database_name, DB_NAME()) AS database_name,
    sed.referenced_server_name,
    
    -- Impact level
    CASE 
        WHEN o.type = 'U' THEN 'üî¥ TABLE - Data dependency'
        WHEN o.type = 'V' THEN 'üü° VIEW - May have underlying table dependencies'
        WHEN o.type = 'P' THEN 'üü¢ PROCEDURE - Logic dependency'
        WHEN o.type IN ('FN', 'IF', 'TF') THEN 'üü¢ FUNCTION - Logic dependency'
        WHEN sed.referenced_class_desc IS NOT NULL THEN '‚ö™ ' + sed.referenced_class_desc
        ELSE '‚ö™ UNKNOWN'
    END AS dependency_impact,
    
    -- Check if the object exists
    CASE 
        WHEN o.object_id IS NULL THEN '‚ùå OBJECT NOT FOUND (may be external/deleted)'
        ELSE '‚úÖ Object exists'
    END AS object_status

FROM sys.sql_expression_dependencies sed
LEFT JOIN sys.objects o ON sed.referenced_id = o.object_id AND o.is_ms_shipped = 0
WHERE sed.referencing_id = OBJECT_ID(@TargetSchema + '.' + @TargetObject)
ORDER BY 
    CASE 
        WHEN o.type = 'U' THEN 1  -- Tables first
        WHEN o.type = 'V' THEN 2  -- Then views
        WHEN o.type = 'P' THEN 3  -- Then procedures
        WHEN o.type IN ('FN', 'IF', 'TF') THEN 4  -- Then functions
        ELSE 5
    END,
    referenced_schema,
    referenced_object,
    referenced_column;

-- =====================================================
-- PART 4: EXTERNAL/MISSING DEPENDENCIES
-- Shows dependencies that couldn't be resolved
-- =====================================================

PRINT '=== EXTERNAL/UNRESOLVED DEPENDENCIES ==='

SELECT 
    sed.referenced_server_name,
    sed.referenced_database_name,
    sed.referenced_schema_name,
    sed.referenced_entity_name,
    sed.referenced_class_desc,
    sed.is_ambiguous,
    
    CASE 
        WHEN sed.referenced_server_name IS NOT NULL THEN 'üåê LINKED SERVER - External dependency'
        WHEN sed.referenced_database_name IS NOT NULL THEN 'üíæ CROSS-DATABASE - Different database'
        WHEN sed.is_ambiguous = 1 THEN '‚ùì AMBIGUOUS - Cannot determine exact object'
        ELSE '‚ö†Ô∏è UNRESOLVED - Object may not exist'
    END AS dependency_type

FROM sys.sql_expression_dependencies sed
WHERE sed.referencing_id = OBJECT_ID(@TargetSchema + '.' + @TargetObject)
    AND sed.referenced_id IS NULL  -- Object doesn't exist in current database
ORDER BY sed.referenced_database_name, sed.referenced_schema_name, sed.referenced_entity_name;

-- =====================================================
-- PART 5: COMPLETE IMPACT SUMMARY
-- =====================================================

PRINT '=== SUMMARY ==='

SELECT 
    'COMPLETE IMPACT ANALYSIS FOR: ' + @TargetSchema + '.' + @TargetObject AS analysis_subject,
    
    -- What uses this object
    (SELECT COUNT(DISTINCT o.object_id) 
     FROM sys.sql_expression_dependencies sed
     INNER JOIN sys.objects o ON sed.referencing_id = o.object_id
     WHERE sed.referenced_id = OBJECT_ID(@TargetSchema + '.' + @TargetObject)
     AND o.is_ms_shipped = 0) AS objects_that_depend_on_this,
    
    -- What this object uses (total)
    (SELECT COUNT(DISTINCT sed.referenced_id)
     FROM sys.sql_expression_dependencies sed
     WHERE sed.referencing_id = OBJECT_ID(@TargetSchema + '.' + @TargetObject)
     AND sed.referenced_id IS NOT NULL) AS objects_this_depends_on,
    
    -- Tables this uses
    (SELECT COUNT(DISTINCT sed.referenced_id)
     FROM sys.sql_expression_dependencies sed
     INNER JOIN sys.objects o ON sed.referenced_id = o.object_id
     WHERE sed.referencing_id = OBJECT_ID(@TargetSchema + '.' + @TargetObject)
     AND o.type = 'U'
     AND o.is_ms_shipped = 0) AS tables_used,
    
    -- Views this uses
    (SELECT COUNT(DISTINCT sed.referenced_id)
     FROM sys.sql_expression_dependencies sed
     INNER JOIN sys.objects o ON sed.referenced_id = o.object_id
     WHERE sed.referencing_id = OBJECT_ID(@TargetSchema + '.' + @TargetObject)
     AND o.type = 'V'
     AND o.is_ms_shipped = 0) AS views_used,
    
    -- Other procedures this calls
    (SELECT COUNT(DISTINCT sed.referenced_id)
     FROM sys.sql_expression_dependencies sed
     INNER JOIN sys.objects o ON sed.referenced_id = o.object_id
     WHERE sed.referencing_id = OBJECT_ID(@TargetSchema + '.' + @TargetObject)
     AND o.type = 'P'
     AND o.is_ms_shipped = 0) AS procedures_called,
    
    -- Functions this uses
    (SELECT COUNT(DISTINCT sed.referenced_id)
     FROM sys.sql_expression_dependencies sed
     INNER JOIN sys.objects o ON sed.referenced_id = o.object_id
     WHERE sed.referencing_id = OBJECT_ID(@TargetSchema + '.' + @TargetObject)
     AND o.type IN ('FN', 'IF', 'TF')
     AND o.is_ms_shipped = 0) AS functions_used,
    
    -- External/unresolved dependencies
    (SELECT COUNT(*)
     FROM sys.sql_expression_dependencies sed
     WHERE sed.referencing_id = OBJECT_ID(@TargetSchema + '.' + @TargetObject)
     AND sed.referenced_id IS NULL) AS external_or_missing_dependencies;

-- =====================================================
-- PART 6: DEFINITION AND METADATA
-- =====================================================

PRINT '=== OBJECT DEFINITION ==='

SELECT 
    SCHEMA_NAME(o.schema_id) AS schema_name,
    o.name AS object_name,
    o.type_desc AS object_type,
    o.create_date,
    o.modify_date,
    OBJECT_DEFINITION(o.object_id) AS object_definition,
    
    -- Parameter count for procedures/functions
    (SELECT COUNT(*) FROM sys.parameters p WHERE p.object_id = o.object_id) AS parameter_count,
    
    -- Lines of code (approximate)
    LEN(OBJECT_DEFINITION(o.object_id)) - LEN(REPLACE(OBJECT_DEFINITION(o.object_id), CHAR(10), '')) + 1 AS approximate_lines_of_code

FROM sys.objects o
WHERE o.name = @TargetObject
    AND SCHEMA_NAME(o.schema_id) = @TargetSchema
    AND o.is_ms_shipped = 0;

-- =====================================================
-- PART 7: PARAMETER DETAILS (for procedures/functions)
-- =====================================================

PRINT '=== PARAMETERS ==='

SELECT 
    p.parameter_id,
    p.name AS parameter_name,
    TYPE_NAME(p.user_type_id) AS data_type,
    p.max_length,
    p.precision,
    p.scale,
    p.is_output,
    p.has_default_value,
    p.is_nullable,
    CASE 
        WHEN TYPE_NAME(p.user_type_id) IN ('varchar', 'nvarchar', 'char', 'nchar', 'varbinary', 'binary') 
        THEN TYPE_NAME(p.user_type_id) + '(' + 
             CASE WHEN p.max_length = -1 THEN 'MAX' 
                  WHEN TYPE_NAME(p.user_type_id) LIKE 'n%' THEN CAST(p.max_length/2 AS VARCHAR(10))
                  ELSE CAST(p.max_length AS VARCHAR(10)) END + ')'
        WHEN TYPE_NAME(p.user_type_id) IN ('decimal', 'numeric') 
        THEN TYPE_NAME(p.user_type_id) + '(' + CAST(p.precision AS VARCHAR(10)) + ',' + 
             CAST(p.scale AS VARCHAR(10)) + ')'
        ELSE TYPE_NAME(p.user_type_id)
    END AS full_data_type
FROM sys.parameters p
WHERE p.object_id = OBJECT_ID(@TargetSchema + '.' + @TargetObject)
ORDER BY p.parameter_id;
