-- =====================================================
-- COMPREHENSIVE DATA DICTIONARY QUERY
-- Extracts all database objects with relevant metadata
-- =====================================================

WITH ObjectDetails AS (
    SELECT 
        -- Object Identification
        o.object_id,
        SCHEMA_NAME(o.schema_id) AS schema_name,
        o.name AS object_name,
        o.type_desc AS object_type,
        CASE o.type
            WHEN 'U' THEN 'Table (User-Defined)'
            WHEN 'V' THEN 'View'
            WHEN 'P' THEN 'Stored Procedure'
            WHEN 'FN' THEN 'Scalar Function'
            WHEN 'IF' THEN 'Inline Table-Valued Function'
            WHEN 'TF' THEN 'Table-Valued Function'
            WHEN 'TR' THEN 'Trigger'
            ELSE o.type_desc
        END AS object_type_friendly,
        
        -- Metadata
        o.create_date,
        o.modify_date,
        OBJECTPROPERTYEX(o.object_id, 'BaseType') AS base_type,
        
        -- Extended Properties (Description/Comments)
        CAST(ep.value AS NVARCHAR(MAX)) AS object_description
        
    FROM sys.objects o
    LEFT JOIN sys.extended_properties ep 
        ON ep.major_id = o.object_id 
        AND ep.minor_id = 0 
        AND ep.name = 'MS_Description'
    WHERE o.type IN ('U', 'V', 'P', 'FN', 'IF', 'TF')
        AND o.is_ms_shipped = 0  -- Exclude system objects
),

ColumnDetails AS (
    SELECT
        c.object_id,
        c.column_id,
        c.name AS column_name,
        TYPE_NAME(c.user_type_id) AS data_type,
        c.max_length,
        c.precision,
        c.scale,
        c.is_nullable,
        c.is_identity,
        c.is_computed,
        cc.definition AS computed_column_definition,
        dc.definition AS default_constraint,
        CAST(ep.value AS NVARCHAR(MAX)) AS column_description,
        
        -- Primary Key Information
        CASE WHEN ic.index_column_id IS NOT NULL AND i.is_primary_key = 1 
            THEN 'YES' ELSE 'NO' END AS is_primary_key,
        
        -- Foreign Key Information
        STUFF((
            SELECT ', ' + OBJECT_SCHEMA_NAME(fk.referenced_object_id) + '.' + 
                   OBJECT_NAME(fk.referenced_object_id) + '(' + 
                   COL_NAME(fkc.referenced_object_id, fkc.referenced_column_id) + ')'
            FROM sys.foreign_key_columns fkc
            INNER JOIN sys.foreign_keys fk ON fkc.constraint_object_id = fk.object_id
            WHERE fkc.parent_object_id = c.object_id 
                AND fkc.parent_column_id = c.column_id
            FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS foreign_key_references,
        
        -- Index Information
        STUFF((
            SELECT ', ' + i2.name + ' (' + 
                   CASE WHEN i2.is_primary_key = 1 THEN 'PK' 
                        WHEN i2.is_unique = 1 THEN 'UQ' 
                        ELSE 'IX' END + ')'
            FROM sys.index_columns ic2
            INNER JOIN sys.indexes i2 ON ic2.object_id = i2.object_id 
                AND ic2.index_id = i2.index_id
            WHERE ic2.object_id = c.object_id 
                AND ic2.column_id = c.column_id
                AND i2.name IS NOT NULL
            FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '') AS indexes
        
    FROM sys.columns c
    LEFT JOIN sys.computed_columns cc ON c.object_id = cc.object_id 
        AND c.column_id = cc.column_id
    LEFT JOIN sys.default_constraints dc ON c.default_object_id = dc.object_id
    LEFT JOIN sys.extended_properties ep ON ep.major_id = c.object_id 
        AND ep.minor_id = c.column_id 
        AND ep.name = 'MS_Description'
    LEFT JOIN sys.index_columns ic ON ic.object_id = c.object_id 
        AND ic.column_id = c.column_id
    LEFT JOIN sys.indexes i ON ic.object_id = i.object_id 
        AND ic.index_id = i.index_id 
        AND i.is_primary_key = 1
    WHERE c.object_id IN (SELECT object_id FROM ObjectDetails WHERE object_type IN ('USER_TABLE', 'VIEW'))
),

ParameterDetails AS (
    SELECT
        p.object_id,
        p.parameter_id,
        p.name AS parameter_name,
        TYPE_NAME(p.user_type_id) AS parameter_type,
        p.max_length,
        p.precision,
        p.scale,
        p.is_output,
        p.has_default_value,
        p.default_value
    FROM sys.parameters p
    WHERE p.object_id IN (
        SELECT object_id FROM ObjectDetails 
        WHERE object_type IN ('SQL_STORED_PROCEDURE', 'SQL_SCALAR_FUNCTION', 
                              'SQL_INLINE_TABLE_VALUED_FUNCTION', 'SQL_TABLE_VALUED_FUNCTION')
    )
),

TableStats AS (
    SELECT
        t.object_id,
        SUM(p.rows) AS row_count,
        SUM(a.total_pages) * 8 / 1024.0 AS total_space_mb,
        SUM(a.used_pages) * 8 / 1024.0 AS used_space_mb,
        SUM(a.data_pages) * 8 / 1024.0 AS data_space_mb
    FROM sys.tables t
    INNER JOIN sys.partitions p ON t.object_id = p.object_id
    INNER JOIN sys.allocation_units a ON p.partition_id = a.container_id
    WHERE p.index_id IN (0, 1)  -- Heap or Clustered Index
    GROUP BY t.object_id
)

-- FINAL OUTPUT: Complete Data Dictionary
SELECT 
    od.schema_name,
    od.object_name,
    od.object_type_friendly AS object_type,
    od.create_date,
    od.modify_date,
    od.object_description,
    
    -- For Tables and Views: Column Information
    cd.column_name,
    cd.data_type,
    CASE 
        WHEN cd.data_type IN ('varchar', 'nvarchar', 'char', 'nchar', 'varbinary', 'binary') 
        THEN cd.data_type + '(' + 
             CASE WHEN cd.max_length = -1 THEN 'MAX' 
                  WHEN cd.data_type LIKE 'n%' THEN CAST(cd.max_length/2 AS VARCHAR(10))
                  ELSE CAST(cd.max_length AS VARCHAR(10)) END + ')'
        WHEN cd.data_type IN ('decimal', 'numeric') 
        THEN cd.data_type + '(' + CAST(cd.precision AS VARCHAR(10)) + ',' + 
             CAST(cd.scale AS VARCHAR(10)) + ')'
        ELSE cd.data_type
    END AS full_data_type,
    cd.is_nullable,
    cd.is_identity,
    cd.is_primary_key,
    cd.foreign_key_references,
    cd.default_constraint,
    cd.is_computed,
    cd.computed_column_definition,
    cd.indexes AS column_indexes,
    cd.column_description,
    
    -- For Stored Procedures and Functions: Parameter Information
    pd.parameter_name,
    pd.parameter_type,
    CASE 
        WHEN pd.parameter_type IN ('varchar', 'nvarchar', 'char', 'nchar', 'varbinary', 'binary') 
        THEN pd.parameter_type + '(' + 
             CASE WHEN pd.max_length = -1 THEN 'MAX' 
                  WHEN pd.parameter_type LIKE 'n%' THEN CAST(pd.max_length/2 AS VARCHAR(10))
                  ELSE CAST(pd.max_length AS VARCHAR(10)) END + ')'
        WHEN pd.parameter_type IN ('decimal', 'numeric') 
        THEN pd.parameter_type + '(' + CAST(pd.precision AS VARCHAR(10)) + ',' + 
             CAST(pd.scale AS VARCHAR(10)) + ')'
        ELSE pd.parameter_type
    END AS full_parameter_type,
    pd.is_output,
    pd.has_default_value,
    
    -- Table Statistics
    ts.row_count,
    ts.total_space_mb,
    ts.used_space_mb,
    ts.data_space_mb,
    
    -- Definition (for views, procedures, functions)
    OBJECT_DEFINITION(od.object_id) AS object_definition

FROM ObjectDetails od
LEFT JOIN ColumnDetails cd ON od.object_id = cd.object_id
LEFT JOIN ParameterDetails pd ON od.object_id = pd.object_id
LEFT JOIN TableStats ts ON od.object_id = ts.object_id

ORDER BY 
    od.schema_name,
    od.object_type_friendly,
    od.object_name,
    cd.column_id,
    pd.parameter_id;
